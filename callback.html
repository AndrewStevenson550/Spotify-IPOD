<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logging in...</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen font-sans">
    <div class="text-center">
        <h1 class="text-2xl font-bold">Logging in to iSpotify...</h1>
        <p class="text-lg mt-2">Please wait, we're connecting to Spotify.</p>
        <p id="error-message" class="text-red-400 mt-4"></p>
    </div>

    <script>
        // This script runs as soon as the page loads
        document.addEventListener('DOMContentLoaded', async () => {
            const errorMessageEl = document.getElementById('error-message');

            // 1. Get the 'code' from the URL
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const state = params.get('state');
            const error = params.get('error');

            // 2. Check for errors from Spotify
            if (error) {
                errorMessageEl.textContent = `Error: ${error}`;
                return;
            }

            // 3. Check the 'state' to make sure it's our request
            const storedState = localStorage.getItem('spotify_auth_state');
            if (!state || state !== storedState) {
                errorMessageEl.textContent = 'Error: State mismatch. Please try logging in again.';
                return;
            }
            localStorage.removeItem('spotify_auth_state'); // Clean up

            // 4. Get the 'code_verifier' we saved before logging in
            const codeVerifier = localStorage.getItem('spotify_code_verifier');
            if (!codeVerifier) {
                errorMessageEl.textContent = 'Error: Code verifier not found. Please try logging in again.';
                return;
            }
            localStorage.removeItem('spotify_code_verifier'); // Clean up

            // --- This is the new PKCE step ---
            // We trade the 'code' for an 'access_token'
            
            const CLIENT_ID = "cc3e477403484a58a4673502ef0a9a70"; // Your Client ID
            const REDIRECT_URI = "http://127.0.0.1:5500/callback.html"; // Must match
            
            const tokenUrl = "https://accounts.spotify.com/api/token";
            const payload = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    client_id: CLIENT_ID,
                    grant_type: 'authorization_code',
                    code: code,
                    redirect_uri: REDIRECT_URI,
                    code_verifier: codeVerifier,
                }),
            };

            try {
                const response = await fetch(tokenUrl, payload);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // 5. Save the tokens!
                localStorage.setItem('spotify_access_token', data.access_token);
                localStorage.setItem('spotify_refresh_token', data.refresh_token);
                // Set expiry time (Spotify tokens last 1 hour)
                const expiresAt = Date.now() + (data.expires_in * 1000);
                localStorage.setItem('spotify_token_expires_at', expiresAt);

                // 6. Send user back to the main app
                // Make sure your main file is named iSpotify_Player.html
                window.location.href = 'iSpotify_Player.html'; 

            } catch (err) {
                console.error('Error fetching token:', err);
                errorMessageEl.textContent = 'Error: Could not get token from Spotify. See console for details.';
            }
        });
    </script>
</body>
</html>
